<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お客様の声 自動作成ツール - 電子カルテシステム</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* review_generator.html固有のスタイル */
        .review-form .form-group {
            margin-bottom: 20px;
        }
        .review-form label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        .review-form input[type="text"],
        .review-form select,
        .review-form textarea  {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #c8c7cc;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box; /* paddingを含めてwidth 100%にする */
        }
        .review-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        .result-container {
            margin-top: 30px;
        }
        .result-container textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #c8c7cc;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.6;
            background-color: #f8f9fa;
            resize: none; /* 手動リサイズを無効化 */
            box-sizing: border-box; /* paddingやborderをwidthに含める */
            overflow-y: hidden; /* 内容が少ない時にスクロールバーを隠す */
        }
        .copy-feedback {
            display: inline-block;
            margin-left: 10px;
            color: green;
            font-weight: bold;
            visibility: hidden; /* 最初は非表示 */
        }
        /* --- ボタン風選択肢のスタイル --- */
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 15px;
        }

        /* 元のinputを画面外に隠す（アクセシビリティのためdisplay:noneは避ける） */
        .radio-group input,
        .checkbox-group input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-group label, .checkbox-group label {
            display: inline-block;
            padding: 8px 16px;
            border: 1px solid #c8c7cc;
            border-radius: 20px; /* 角を丸くしてピル形状に */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            background-color: #ffffff;
            color: #333;
        }

        /* 未選択のボタンをホバーした時のスタイル */
        .radio-group label:hover, .checkbox-group label:hover {
            border-color: #8e8e93;
            background-color: #f8f9fa;
        }

        /* 選択された時のスタイル */
        .radio-group input:checked + label,
        .checkbox-group input:checked + label {
            background-color: #007aff; /* iOSのアクセントカラー */
            color: #ffffff;
            border-color: #007aff;
        }

        /* 選択済みのボタンをホバーした時のスタイル */
        .radio-group input:checked + label:hover,
        .checkbox-group input:checked + label:hover {
            background-color: #005ecb; /* 少し濃い青 */
            border-color: #005ecb;
        }
        .type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid #e5e5e7;
            padding-bottom: 20px;
        }
        .type-selector .type-button {
            padding: 8px 16px;
            border: 1px solid #007aff;
            background-color: #ffffff;
            color: #007aff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
        }
        .type-selector .type-button:hover { background-color: #f0f2f5; }
        .type-selector .type-button.active { background-color: #007aff; color: #ffffff; }

        /* --- 今風のボタンUI --- */
        .button-primary, .button-secondary {
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-block;
            text-align: center;
        }
        .button-primary {
            background-color: #007aff;
            color: white;
        }
        .button-primary:hover {
            background-color: #005ecb;
        }
        .button-primary:disabled,
        .button-secondary:disabled {
            background-color: #c8c7cc;
            color: #8e8e93;
            cursor: not-allowed;
        }
        .button-secondary {
            background-color: #e5e5e7;
            color: #1c1c1e;
            font-weight: 500;
            padding: 10px 16px;
        }
        .button-secondary:hover {
            background-color: #d1d1d6;
        }
        .button-secondary.copied {
            background-color: #28a745; /* 成功を示す緑色 */
            color: white;
        }
        .result-actions {
            display: flex;
            justify-content: flex-start; /* ボタンを左寄せに変更 */
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        /* --- スライダーのスタイル --- */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .slider-container input[type="range"] {
            flex-grow: 1;
        }
        .slider-container .slider-value {
            font-weight: 500;
            min-width: 60px; /* 文字数表示の幅を確保 */
            text-align: right;
        }
    </style>
    <script src="common.js" defer></script>
    <script src="configs.js" defer></script>
</head>
<body>
    <div id="header-placeholder"></div>
    <div id="nav-placeholder"></div>

    <main>
        <h2 style="font-weight: 600; margin-bottom: 16px;">お客様の声 自動作成ツール</h2>
        <div id="type-selector-container" class="type-selector"></div>
        <p style="margin-bottom: 24px; color: #6c6c70;"></p>

        <div class="card">
            <form id="reviewForm" class="review-form"></form>
            <div id="button-container" style="margin-top: 20px;">
                <button type="button" id="generateButton" class="button-primary">お声を作成する</button>
            </div>
        </div>

        <div id="resultContainer" class="result-container card" style="display: none;">
            <h3>生成されたお客様の声(案)</h3>
            <textarea id="reviewResult" readonly></textarea>
            <div class="result-actions"></div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const main = document.querySelector('main');
            const generateButton = document.getElementById('generateButton');
            const resultContainer = document.getElementById('resultContainer');
            const reviewResult = document.getElementById('reviewResult');

            // --- APIエンドポイントの設定 ---
            // 本番環境のURL（ご自身のサーバーのURLに合わせてください）
            const API_BASE_URL_PROD = 'https://revision-co.jp';
            // 開発環境のURL
            const API_BASE_URL_DEV = 'http://localhost:5001';
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const apiEndpoint = (isDevelopment ? API_BASE_URL_DEV : API_BASE_URL_PROD) + '/generate-review';

            /**
             * テキストエリアの高さを内容に応じて自動調整する関数
             * @param {HTMLTextAreaElement} textarea - 対象のテキストエリア
             */
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto'; // 一旦高さをリセットしてscrollHeightを正しく計算
                textarea.style.height = (textarea.scrollHeight) + 'px'; // scrollHeightを使って高さを設定
            }

            // --- ページの初期化処理 ---
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type') || 'salon'; // URLにtypeがなければsalonをデフォルトに
            const currentConfig = configs[type];

            if (!currentConfig) {
                main.innerHTML = `<div class="card"><p>エラー: 「${type}」という業態の設定が見つかりません。</p></div>`;
                return; // 設定がなければここで処理を終了
            }

            // --- 業態選択ボタンの生成 ---
            const typeSelectorContainer = document.getElementById('type-selector-container');
            Object.keys(configs).forEach(key => {
                const config = configs[key];
                const button = document.createElement('a');
                button.href = `review_generator.html?type=${key}`;
                button.textContent = config.typeName || key; // typeNameプロパティを使用
                button.className = 'type-button';
                if (key === type) {
                    button.classList.add('active');
                }
                typeSelectorContainer.appendChild(button);
            });

            // ページタイトルと見出しを設定
            document.title = currentConfig.pageTitle;
            main.querySelector('h2').textContent = currentConfig.mainTitle;
            main.querySelector('p').textContent = currentConfig.description;

            // フォームを動的に構築
            const formContainer = document.getElementById('reviewForm');
            buildForm(currentConfig.questions, formContainer);

            // ボタンと結果のタイトルを設定
            generateButton.textContent = currentConfig.submitButtonText;
            resultContainer.querySelector('h3').textContent = currentConfig.resultTitle;

            generateButton.addEventListener('click', async () => {
                const formData = collectFormData(currentConfig.questions);

                // バックエンドに送信する基本データを作成
                const requestData = {
                    formData: formData
                };

                // AIへの役割指示を動的に組み立てる
                let dynamicPromptContext = currentConfig.promptContext;
                const additionalInstructions = [];

                // 店名が設定されている場合、ランダムに選択
                if (currentConfig.storeNames && currentConfig.storeNames.length > 0) {
                    const randomStoreName = currentConfig.storeNames[Math.floor(Math.random() * currentConfig.storeNames.length)];
                    additionalInstructions.push(`- **店名の使用**: 文章のどこかで ${randomStoreName} という店名を自然な形で一度だけ使用してください。`);
                }

                // 地名とキーワードのリストが設定されている場合、ランダムに選択
                if (currentConfig.locations && currentConfig.locations.length > 0 &&
                    currentConfig.keywords && currentConfig.keywords.length > 0) {

                    // 地名リストからランダムに1つ選択
                    const randomLocation = currentConfig.locations[Math.floor(Math.random() * currentConfig.locations.length)];

                    // キーワードリストをシャッフルし、先頭から1つまたは2つ取得（50%の確率で数を変える）
                    const shuffledKeywords = [...currentConfig.keywords].sort(() => 0.5 - Math.random());
                    const keywordCount = Math.random() < 0.5 ? 1 : 2;
                    const randomKeywords = shuffledKeywords.slice(0, keywordCount);

                    // AIへの追加指示を作成（より自然な表現を促すように変更）
                    additionalInstructions.push(`- **地名とキーワードの活用**: 文章のどこかに ${randomLocation} という地名と、${randomKeywords.join('や')} といったキーワードを、それぞれ最低1回は含めてください。ただし、いかにも宣伝のような不自然な文章にならないよう、あくまで顧客自身の言葉として自然に聞こえるように工夫してください。`);
                }

                if (additionalInstructions.length > 0) {
                    dynamicPromptContext += "\n\n" + additionalInstructions.join('\n');
                }
                requestData.promptContext = dynamicPromptContext;

                // 選択・入力された項目の数をカウント
                let answerCount = 0;
                Object.values(formData).forEach(value => {
                    if (Array.isArray(value)) {
                        answerCount += value.length;
                    } else if (value) {
                        answerCount++;
                    }
                });

                if (answerCount < 3) {
                    alert('３つ以上選択回答して下さい。');
                    return; // 3つ未満の場合は処理を中断
                }

                // ボタンを無効化し、ローディング表示
                generateButton.disabled = true;
                generateButton.textContent = 'AIが生成中です...';
                resultContainer.style.display = 'none'; // 前回の結果を隠す

                try {
                    // バックエンドのAPIにリクエストを送信
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        // サーバーからの詳細なエラーメッセージを取得試行
                        let errorMessage = `サーバーエラー: ${response.status} (${response.statusText})`;
                        try {
                            const errorResult = await response.json();
                            if (errorResult && errorResult.error) {
                                errorMessage = errorResult.error; // サーバーからの詳細エラーで上書き
                            }
                        } catch (e) {
                            // レスポンスがJSONでない場合は何もしない
                        }
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();

                    if (result.review) {
                        // 結果を表示
                        reviewResult.value = result.review.trim();
                        resultContainer.style.display = 'block';
                        autoResizeTextarea(reviewResult); // テキスト量に応じて高さを調整

                        // --- ボタンの動的生成 ---
                        const resultActionsDiv = document.querySelector('.result-actions');
                        resultActionsDiv.innerHTML = ''; // 既存のボタンをクリア

                        // 1. 「クリップボードにコピー」ボタンを作成
                        const newCopyButton = document.createElement('button');
                        newCopyButton.type = 'button';
                        newCopyButton.className = 'button-secondary';
                        newCopyButton.textContent = 'クリップボードにコピー';

                        // 2. コピーボタンのクリックイベントを設定
                        newCopyButton.onclick = () => {
                            navigator.clipboard.writeText(result.review.trim()).then(() => {
                                // コピー成功時の処理
                                newCopyButton.textContent = 'コピーしました！';
                                newCopyButton.disabled = true;
                                newCopyButton.classList.add('copied');

                                // 3. 口コミ投稿用のリンクボタンを作成して表示
                                // 設定ファイルにURLがあればボタンを生成
                                if (currentConfig.reviewPostUrl) {
                                    const postLink = document.createElement('a');
                                    postLink.className = 'button-primary';
                                    postLink.target = '_blank';
                                    postLink.textContent = '投稿画面に移動する';
                                    postLink.href = currentConfig.reviewPostUrl;
                                    resultActionsDiv.appendChild(postLink);
                                }

                            }).catch(err => {
                                console.error('クリップボードへのコピーに失敗しました:', err);
                                alert('コピーに失敗しました。');
                            });
                        };
                        resultActionsDiv.appendChild(newCopyButton);

                    } else if (result.error) {
                        throw new Error(result.error);
                    } else {
                        throw new Error('AIからの応答が予期しない形式です。');
                    }

                } catch (error) {
                    console.error('お声の生成に失敗しました:', error.message);
                    reviewResult.value = `エラーが発生しました:\n\n${error.message}`;
                    resultContainer.style.display = 'block';
                    autoResizeTextarea(reviewResult); // エラー表示でも高さを調整
                } finally {
                    // ボタンを元に戻す
                    generateButton.disabled = false;
                    generateButton.textContent = currentConfig.submitButtonText || '作成する';
                }
            });

        });
    </script>
</body>
</html>