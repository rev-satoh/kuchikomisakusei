# お客様の声 自動作成ツール - プロジェクト仕様説明書

## 1. プロジェクト概要

本プロジェクトは、サロンや買取店などの店舗スタッフが、簡単なアンケート形式の入力を行うだけで、AI(Google Gemini)を活用してお客様の声（レビュー文章）の草案を自動生成するためのウェブアプリケーションです。

- **目的**: レビュー投稿を促進し、店舗のオンライン評価を向上させるための業務を効率化する。
- **主な機能**:
    - 店舗ごとにカスタマイズされたアンケートフォームを動的に生成。
    - フォームの入力内容に基づき、AIが自然で魅力的なレビュー文章を作成。
    - 生成された文章のコピーや、指定された投稿ページへの遷移をサポート。

---

## 2. 技術スタックとアーキテクチャ

本システムは、ユーザーが操作する「フロントエンド」と、AIとの通信を担う「バックエンド」が分離された構成になっています。

### 技術スタック
- **フロントエンド**: HTML, CSS, JavaScript (外部ライブラリなし)
- **バックエンド**: Python 3, Flask
- **AIモデル**: Google Gemini (`gemini-1.5-flash-latest`)
- **デプロイ環境**:
    - **フロントエンド**: GitHub Pages
    - **バックエンド**: Render

### アーキテクチャ図

```
┌───────────────┐      (HTTPS Request)      ┌──────────────────┐      (API Request)      ┌─────────────┐
│   ユーザー      │ ◀─────────────────────▶ │  フロントエンド    │ ◀───────────────────▶ │ バックエンド  │ ◀───────────▶ │ Google AI   │
│ (ブラウザ)      │                         │ (GitHub Pages)   │                         │ (Render)      │             │ (Gemini API)│
└───────────────┘                         └──────────────────┘                         └─────────────┘             └─────────────┘
```

### デプロイとCI/CD
- **リポジトリ**: `https://github.com/rev-satoh/kuchikomisakusei`
- **フロントエンドURL**: `https://rev-satoh.github.io/kuchikomisakusei/`
- **バックエンドURL**: `https://kuchikomi-api.onrender.com/`

`main`ブランチに`git push`すると、GitHub Actionsがフロントエンドを、Renderがバックエンドをそれぞれ自動でデプロイします。

---

## 3. ファイル構成と役割

```
kuchikomisakusei/
├── app.py                  # バックエンド: Flaskアプリケーション本体
├── configs.js              # フロントエンド: ★最重要★ 店舗ごとの設定ファイル
├── review_generator.js     # フロントエンド: メインのJavaScriptロジック
├── review_generator.html   # フロントエンド: メインのHTMLファイル
├── index.html              # フロントエンド: ルートURLからのリダイレクト用
├── style.css               # フロントエンド: 共通スタイルシート
├── common.js               # フロントエンド: ヘッダー/フッター読込などの共通処理
├── header.html             # 共通部品: ヘッダー
├── footer.html             # 共通部品: フッター
├── favicon.ico             # ファビコン
├── requirements.txt        # バックエンド: Pythonの依存ライブラリリスト
├── prompt_template.txt     # バックエンド: AIへの指示テンプレート
├── .gitignore              # Gitの管理対象外ファイルを設定
└── .env                    # (ローカル開発用) APIキーを格納 ※Git管理対象外
```

---

## 4. 主要な機能とロジック

### フロントエンド (`review_generator.js`)

1.  **設定の読み込み**:
    - ページのURLに含まれるハッシュ (`...html#/ksl-h` の `#ksl-h` 部分) を店舗IDとして解釈します。
    - `configs.js` から、その店舗IDに対応する設定オブジェクト（質問項目、AIへの指示、キーワード等）を読み込みます。

2.  **動的フォーム生成**:
    - 読み込んだ設定オブジェクトの `questions` 配列を元に、`buildForm` 関数がHTMLのフォーム要素（ラジオボタン、チェックボックス、スライダー等）を動的にページ上に構築します。

3.  **レビュー生成処理**:
    - 「お声を作成する」ボタンがクリックされると、以下の処理が実行されます。
    - **入力検証**: 4つ以上の項目が入力されているかチェックします。
    - **リクエストデータ構築**:
        - `collectFormData` 関数でフォームの入力内容を収集します。
        - `configs.js` の設定（店名、地名、キーワード）からランダムに要素を選択し、AIへの動的な追加指示を生成します。
    - **API通信**:
        - `fetch` APIを使い、Render上で稼働しているバックエンドの `/generate-review` エンドポイントに、構築したリクエストデータをJSON形式でPOSTします。

4.  **結果表示**:
    - **成功時**: バックエンドから返されたレビュー文章をテキストエリアに表示します。同時に、「クリップボードにコピー」ボタンと、設定にあれば「投稿画面に移動する」ボタンを動的に生成します。
    - **失敗時**: バックエンドから返されたエラーメッセージを、専用のエラー表示領域に表示します。

### バックエンド (`app.py`)

1.  **APIエンドポイント `/generate-review`**:
    - フロントエンドからのPOSTリクエストを受け付けます。
    - リクエストボディから `promptContext` (AIへの指示) と `formData` (アンケート結果) を取り出します。
    - `prompt_template.txt` から読み込んだテンプレートに、受け取った情報やアンケート詳細を埋め込み、最終的なプロンプトを完成させます。
    - `google-generativeai` ライブラリを使い、完成したプロンプトをGoogle Gemini APIに送信します。

2.  **レスポンス処理**:
    - AIからの応答テキストを受け取ります。
    - **改行・空白の整形**:
        - AIの応答に含まれる3つ以上の連続した改行を2つにまとめ、文章の先頭と末尾の不要な空白を除去します。
        - その後、以下の3つの改行スタイルからランダムに1つを適用し、出力の見た目に多様性を持たせます。
            1.  **段落スタイル**: 空白行で段落を区切る、最も標準的なスタイル。
            2.  **こまめな改行スタイル**: 段落間の空白行をなくし、文の区切りで改行するスタイル。
            3.  **ブロック文章スタイル**: 改行をほぼなくし、文章全体を一つの塊として表示するスタイル。
    - 整形した最終的なレビュー文章を、JSON形式でフロントエンドに返します。

3.  **エラーハンドリング**:
    - Google APIの認証エラーや不正な引数エラーなどを個別に捕捉し、分かりやすいエラーメッセージをJSONで返します。
    - その他の予期せぬサーバーエラーも捕捉し、500エラーとして処理します。
